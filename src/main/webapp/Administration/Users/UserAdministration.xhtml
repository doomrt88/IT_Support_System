<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
	xmlns:f="http://xmlns.jcp.org/jsf/core"
	xmlns:p="http://primefaces.org/ui">

	<div class="container">
		<h2>User Management</h2>

		<p:commandButton value="Create User"
			action="#{userAdministrationBean.createUser}" update="userForm"
			onclick="PF('userDialog').show()" styleClass="mb-3"/>
		<h:form id="userListForm">
			<p:growl id="userMessages" showDetail="true" />
			<p:dataTable id="usersTable"
				value="#{userAdministrationBean.userList}" var="user"
				styleClass="table striped table-sm" paginator="true" rows="5"  paginatorPosition="bottom">
				<p:column headerText="Name">#{user.username}</p:column>
				<p:column headerText="First Name">#{user.firstName}</p:column>
				<p:column headerText="Last Name">#{user.lastName}</p:column>
				<p:column headerText="Action">
					<p:commandButton value="Edit"
						action="#{userAdministrationBean.editUser(user)}" 
						oncomplete="PF('userDialog').show()" update="userDialog"
						styleClass="ui-button-outlined mr-2" />
						
					<p:commandButton value="Delete"
						action="#{userAdministrationBean.deleteUser(user.id)}"
						onclick="return confirm('Are you sure you want to delete user #{user.username}?')"
						update=":userListForm:usersTable :userListForm:userMessages"
						styleClass="ui-button-outlined ui-button-danger">
						<f:ajax execute="@this" render="@form" />
					</p:commandButton>
				</p:column>
			</p:dataTable>
		</h:form>
	</div>

	<p:dialog id="userDialog" widgetVar="userDialog" modal="true" minHeight="40" width="450" 
		resizable="false" showEffect="fade" hideEffect="fade">
		<h:form id="userForm">
			<h:inputHidden id="id" value="#{userAdministrationBean.userForm.id}" />
			<div class="form-group">
				<label for="name">Name:</label>
				<h:inputText id="name" class="form-control" value="#{userAdministrationBean.userForm.username}" required="true" requiredMessage="Name is required" autocomplete="off" />
				<div class="text-left" style="color: red;">
					<h:message for="name" id="errUsername" />
				</div>
			</div>
						
			<div class="form-group">
                <label for="password">Password:</label>
                <h:inputSecret id="password" class="form-control" value="#{userAdministrationBean.userForm.password}" required="true" requiredMessage="Password is required" autocomplete="off"/>
                <div class="text-left" style="color:red;">
                    <h:message for="password" id="errPassword"/>
                </div>
            </div>
            <div class="form-group">
                <label for="confirmPassword">Confirm Password:</label>
                <h:inputSecret id="confirmPassword" class="form-control" value="#{userAdministrationBean.userForm.confirmPassword}" required="true" requiredMessage="Password is required" autocomplete="off" />
                <div class="text-left" style="color:red;">
                    <h:message for="confirmPassword" id="errConfirmPassword"/>
                </div>
            </div>
            <div class="form-group">
                <label for="firstName">First Name:</label>
                <h:inputText id="firstName" class="form-control" value="#{userAdministrationBean.userForm.firstName}" required="true" requiredMessage="First name is required" autocomplete="off" />
                <div class="text-left" style="color:red;">
                    <h:message for="firstName" id="errFirstName"/>
                </div>
            </div>
            <div class="form-group">
                <label for="lastName">Last Name:</label>
                <h:inputText id="lastName" class="form-control" value="#{userAdministrationBean.userForm.lastName}" autocomplete="off" />
            </div>
            <div class="form-group">
                <label for="roleId">Role:</label>
                <h:selectOneMenu id="roleId" class="form-control" value="#{userAdministrationBean.userForm.roleId}">
                    <f:selectItems value="#{userAdministrationBean.roles}" var="role" itemLabel="#{role.name}" itemValue="#{role.id}" />
                </h:selectOneMenu>
            </div>
            
			<p:commandButton id="saveButton" value="Save"
				action="#{userAdministrationBean.saveUser}" styleClass="mr-2"
				oncomplete="handleSaveUserEvent(xhr, status, args)"  update=":userListForm:usersTable :userListForm:userMessages" />
			<p:commandButton type="button" value="Cancel"
				onclick="PF('userDialog').hide()" styleClass="ui-button-warning" />
		</h:form>
		
		<f:facet name="header">
	        <h:outputText value="#{userAdministrationBean.userForm.id > 0 ? 'Update User' : 'Add New User'}" />
	    </f:facet>
	</p:dialog>

	<script>
		function handleSaveUserEvent(xhr, status, args) {
	        if (!args.validationFailed) {
	            PF('userDialog').hide();
	        }
	    }
    </script>

</ui:composition>
